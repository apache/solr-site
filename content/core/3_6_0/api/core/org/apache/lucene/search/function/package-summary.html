<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!-- NewPage -->
<html lang="en">
<head>
<!-- Generated by javadoc (version 1.7.0_01) on Wed Apr 11 21:47:02 EDT 2012 -->
<meta http-equiv="Content-Type" content="text/html" charset="utf-8">
<title>org.apache.lucene.search.function (Lucene 3.6.0 API)</title>
<meta name="date" content="2012-04-11">
<link rel="stylesheet" type="text/css" href="../../../../../stylesheet.css" title="Style">
</head>
<body>
<script type="text/javascript"><!--
    if (location.href.indexOf('is-external=true') == -1) {
        parent.document.title="org.apache.lucene.search.function (Lucene 3.6.0 API)";
    }
//-->
</script>
<noscript>
<div>JavaScript is disabled on your browser.</div>
</noscript>
<!-- ========= START OF TOP NAVBAR ======= -->
<div class="topNav"><a name="navbar_top">
<!--   -->
</a><a href="#skip-navbar_top" title="Skip navigation links"></a><a name="navbar_top_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-use.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../org/apache/lucene/search/package-summary.html">Prev Package</a></li>
<li><a href="../../../../../org/apache/lucene/search/payloads/package-summary.html">Next Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../index.html?org/apache/lucene/search/function/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_top">
<li><a href="../../../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_top");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip-navbar_top">
<!--   -->
</a></div>
<!-- ========= END OF TOP NAVBAR ========= -->
<div class="header">
<h1 title="Package" class="title">Package&nbsp;org.apache.lucene.search.function</h1>
<div class="docSummary">
<div class="block"><DIV>
  Programmatic control over documents scores.</div>
</div>
<p>See:&nbsp;<a href="#package_description">Description</a></p>
</div>
<div class="contentContainer">
<ul class="blockList">
<li class="blockList">
<table class="packageSummary" border="0" cellpadding="3" cellspacing="0" summary="Class Summary table, listing classes, and an explanation">
<caption><span>Class Summary</span><span class="tabEnd">&nbsp;</span></caption>
<tr>
<th class="colFirst" scope="col">Class</th>
<th class="colLast" scope="col">Description</th>
</tr>
<tbody>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/ByteFieldSource.html" title="class in org.apache.lucene.search.function">ByteFieldSource</a></td>
<td class="colLast">
<div class="block">Expert: obtains single byte field values from the 
 <a href="../../../../../org/apache/lucene/search/FieldCache.html" title="interface in org.apache.lucene.search"><code>FieldCache</code></a>
 using <code>getBytes()</code> and makes those values 
 available as other numeric types, casting as needed.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/CustomScoreProvider.html" title="class in org.apache.lucene.search.function">CustomScoreProvider</a></td>
<td class="colLast">
<div class="block">An instance of this subclass should be returned by
 <a href="../../../../../org/apache/lucene/search/function/CustomScoreQuery.html#getCustomScoreProvider(org.apache.lucene.index.IndexReader)"><code>CustomScoreQuery.getCustomScoreProvider(org.apache.lucene.index.IndexReader)</code></a>, if you want
 to modify the custom score calculation of a <a href="../../../../../org/apache/lucene/search/function/CustomScoreQuery.html" title="class in org.apache.lucene.search.function"><code>CustomScoreQuery</code></a>.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/CustomScoreQuery.html" title="class in org.apache.lucene.search.function">CustomScoreQuery</a></td>
<td class="colLast">
<div class="block">Query that sets document score as a programmatic function of several (sub) scores:
 
    the score of its subQuery (any query)
    (optional) the score of its ValueSourceQuery (or queries).</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/DocValues.html" title="class in org.apache.lucene.search.function">DocValues</a></td>
<td class="colLast">
<div class="block">Expert: represents field values as different types.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/FieldCacheSource.html" title="class in org.apache.lucene.search.function">FieldCacheSource</a></td>
<td class="colLast">
<div class="block">Expert: A base class for ValueSource implementations that retrieve values for
 a single field from the <a href="../../../../../org/apache/lucene/search/FieldCache.html" title="interface in org.apache.lucene.search"><code>FieldCache</code></a>.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/FieldScoreQuery.html" title="class in org.apache.lucene.search.function">FieldScoreQuery</a></td>
<td class="colLast">
<div class="block">A query that scores each document as the value of the numeric input field.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/FieldScoreQuery.Type.html" title="class in org.apache.lucene.search.function">FieldScoreQuery.Type</a></td>
<td class="colLast">
<div class="block">Type of score field, indicating how field values are interpreted/parsed.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/FloatFieldSource.html" title="class in org.apache.lucene.search.function">FloatFieldSource</a></td>
<td class="colLast">
<div class="block">Expert: obtains float field values from the 
 <a href="../../../../../org/apache/lucene/search/FieldCache.html" title="interface in org.apache.lucene.search"><code>FieldCache</code></a>
 using <code>getFloats()</code> and makes those values 
 available as other numeric types, casting as needed.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/IntFieldSource.html" title="class in org.apache.lucene.search.function">IntFieldSource</a></td>
<td class="colLast">
<div class="block">Expert: obtains int field values from the 
 <a href="../../../../../org/apache/lucene/search/FieldCache.html" title="interface in org.apache.lucene.search"><code>FieldCache</code></a>
 using <code>getInts()</code> and makes those values 
 available as other numeric types, casting as needed.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/OrdFieldSource.html" title="class in org.apache.lucene.search.function">OrdFieldSource</a></td>
<td class="colLast">
<div class="block">Expert: obtains the ordinal of the field value from the default Lucene 
 <a href="../../../../../org/apache/lucene/search/FieldCache.html" title="interface in org.apache.lucene.search"><code>Fieldcache</code></a> using getStringIndex().</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/ReverseOrdFieldSource.html" title="class in org.apache.lucene.search.function">ReverseOrdFieldSource</a></td>
<td class="colLast">
<div class="block">Expert: obtains the ordinal of the field value from the default Lucene 
 <a href="../../../../../org/apache/lucene/search/FieldCache.html" title="interface in org.apache.lucene.search"><code>FieldCache</code></a> using getStringIndex()
 and reverses the order.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/ShortFieldSource.html" title="class in org.apache.lucene.search.function">ShortFieldSource</a></td>
<td class="colLast">
<div class="block">Expert: obtains short field values from the 
 <a href="../../../../../org/apache/lucene/search/FieldCache.html" title="interface in org.apache.lucene.search"><code>FieldCache</code></a>
 using <code>getShorts()</code> and makes those values 
 available as other numeric types, casting as needed.</div>
</td>
</tr>
<tr class="altColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/ValueSource.html" title="class in org.apache.lucene.search.function">ValueSource</a></td>
<td class="colLast">
<div class="block">Expert: source of values for basic function queries.</div>
</td>
</tr>
<tr class="rowColor">
<td class="colFirst"><a href="../../../../../org/apache/lucene/search/function/ValueSourceQuery.html" title="class in org.apache.lucene.search.function">ValueSourceQuery</a></td>
<td class="colLast">
<div class="block">Expert: A Query that sets the scores of document to the
 values obtained from a <a href="../../../../../org/apache/lucene/search/function/ValueSource.html" title="class in org.apache.lucene.search.function"><code>ValueSource</code></a>.</div>
</td>
</tr>
</tbody>
</table>
</li>
</ul>
<a name="package_description">
<!--   -->
</a>
<h2 title="Package org.apache.lucene.search.function Description">Package org.apache.lucene.search.function Description</h2>
<div class="block"><DIV>
  Programmatic control over documents scores.
</DIV>
<DIV>
  The <code>function</code> package provides tight control over documents scores.
</DIV>
<DIV></div>
<dl><dt><span class="strong">WARNING: This API is experimental and might change in incompatible ways in the next release.</span></dt>
  <dd></DIV>
<DIV>
  Two types of queries are available in this package:
</DIV>
<DIV>
  <ol>
     <li>
        <b>Custom Score queries</b> - allowing to set the score
        of a matching document as a mathematical expression over scores
        of that document by contained (sub) queries.
     </li>
     <li>
        <b>Field score queries</b> - allowing to base the score of a
        document on <b>numeric values</b> of <b>indexed fields</b>.
     </li>
  </ol>
</DIV>
<DIV>&nbsp;</DIV>
<DIV>
  <b>Some possible uses of these queries:</b>
</DIV>
<DIV>
  <ol>
     <li>
        Normalizing the document scores by values indexed in a special field -
        for instance, experimenting with a different doc length normalization.
     </li>
     <li>
        Introducing some static scoring element, to the score of a document, -
        for instance using some topological attribute of the links to/from a document.
     </li>
     <li>
        Computing the score of a matching document as an arbitrary odd function of
        its score by a certain query.
     </li>
  </ol>
</DIV>
<DIV>
  <b>Performance and Quality Considerations:</b>
</DIV>
<DIV>
  <ol>
     <li>
       When scoring by values of indexed fields,
       these values are loaded into memory.
       Unlike the regular scoring, where the required information is read from
       disk as necessary, here field values are loaded once and cached by Lucene in memory
       for further use, anticipating reuse by further queries. While all this is carefully
       cached with performance in mind, it is recommended to
       use these features only when the default Lucene scoring does
       not match your "special" application needs.
     </li>
     <li>
        Use only with carefully selected fields, because in most cases,
        search quality with regular Lucene scoring
        would outperform that of scoring by field values.
     </li>
     <li>
        Values of fields used for scoring should match.
        Do not apply on a field containing arbitrary (long) text.
        Do not mix values in the same field if that field is used for scoring.
     </li>
     <li>
        Smaller (shorter) field tokens means less RAM (something always desired).
        When using <a href=FieldScoreQuery.html>FieldScoreQuery</a>,
        select the shortest <a href=FieldScoreQuery.html#Type>FieldScoreQuery.Type</a>
        that is sufficient for the used field values.
     </li>
     <li>
        Reusing IndexReaders/IndexSearchers is essential, because the caching of field tokens
        is based on an IndexReader. Whenever a new IndexReader is used, values currently in the cache
        cannot be used and new values must be loaded from disk. So replace/refresh readers/searchers in
        a controlled manner.
     </li>
  </ol>
</DIV>
<DIV>
  <b>History and Credits:</b>
  <ul>
    <li>
       A large part of the code of this package was originated from Yonik's FunctionQuery code that was
       imported from <a href="http://lucene.apache.org/solr">Solr</a>
       (see <a href="http://issues.apache.org/jira/browse/LUCENE-446">LUCENE-446</a>).
    </li>
    <li>
       The idea behind CustomScoreQurey is borrowed from
       the "Easily create queries that transform sub-query scores arbitrarily" contribution by Mike Klaas
       (see <a href="http://issues.apache.org/jira/browse/LUCENE-850">LUCENE-850</a>)
       though the implementation and API here are different.
    </li>
  </ul>
</DIV>
<DIV>
 <b>Code sample:</b>
 <P>
 Note: code snippets here should work, but they were never really compiled... so,
 tests sources under TestCustomScoreQuery, TestFieldScoreQuery and TestOrdValues
 may also be useful.
 <ol>
  <li>
    Using field (byte) values to as scores:
    <p>
    Indexing:
    <pre class="prettyprint">
      f = new Field("score", "7", Field.Store.NO, Field.Index.UN_TOKENIZED);
      f.setOmitNorms(true);
      d1.add(f);
    </pre>
    <p>
    Search:
    <pre class="prettyprint">
      Query q = new FieldScoreQuery("score", FieldScoreQuery.Type.BYTE);
    </pre>
    Document d1 above would get a score of 7.
  </li>
  <p>
  <li>
    Manipulating scores
    <p>
    Dividing the original score of each document by a square root of its docid
    (just to demonstrate what it takes to manipulate scores this way)
    <pre class="prettyprint">
      Query q = queryParser.parse("my query text");
      CustomScoreQuery customQ = new CustomScoreQuery(q) {
        public float customScore(int doc, float subQueryScore, float valSrcScore) {
          return subQueryScore / Math.sqrt(docid);
        }
      };
    </pre>
        <p>
        For more informative debug info on the custom query, also override the name() method:
        <pre class="prettyprint">
      CustomScoreQuery customQ = new CustomScoreQuery(q) {
        public float customScore(int doc, float subQueryScore, float valSrcScore) {
          return subQueryScore / Math.sqrt(docid);
        }
        public String name() {
          return "1/sqrt(docid)";
        }
      };
    </pre>
        <p>
        Taking the square root of the original score and multiplying it by a "short field driven score", ie, the
        short value that was indexed for the scored doc in a certain field:
        <pre class="prettyprint">
      Query q = queryParser.parse("my query text");
      FieldScoreQuery qf = new FieldScoreQuery("shortScore", FieldScoreQuery.Type.SHORT);
      CustomScoreQuery customQ = new CustomScoreQuery(q,qf) {
        public float customScore(int doc, float subQueryScore, float valSrcScore) {
          return Math.sqrt(subQueryScore) * valSrcScore;
        }
        public String name() {
          return "shortVal*sqrt(score)";
        }
      };
    </pre>

  </li>
 </ol>
</DIV></dd></dl>
</div>
<!-- ======= START OF BOTTOM NAVBAR ====== -->
<div class="bottomNav"><a name="navbar_bottom">
<!--   -->
</a><a href="#skip-navbar_bottom" title="Skip navigation links"></a><a name="navbar_bottom_firstrow">
<!--   -->
</a>
<ul class="navList" title="Navigation">
<li><a href="../../../../../overview-summary.html">Overview</a></li>
<li class="navBarCell1Rev">Package</li>
<li>Class</li>
<li><a href="package-use.html">Use</a></li>
<li><a href="package-tree.html">Tree</a></li>
<li><a href="../../../../../deprecated-list.html">Deprecated</a></li>
<li><a href="../../../../../index-all.html">Index</a></li>
<li><a href="../../../../../help-doc.html">Help</a></li>
</ul>
</div>
<div class="subNav">
<ul class="navList">
<li><a href="../../../../../org/apache/lucene/search/package-summary.html">Prev Package</a></li>
<li><a href="../../../../../org/apache/lucene/search/payloads/package-summary.html">Next Package</a></li>
</ul>
<ul class="navList">
<li><a href="../../../../../index.html?org/apache/lucene/search/function/package-summary.html" target="_top">Frames</a></li>
<li><a href="package-summary.html" target="_top">No Frames</a></li>
</ul>
<ul class="navList" id="allclasses_navbar_bottom">
<li><a href="../../../../../allclasses-noframe.html">All Classes</a></li>
</ul>
<div>
<script type="text/javascript"><!--
  allClassesLink = document.getElementById("allclasses_navbar_bottom");
  if(window==top) {
    allClassesLink.style.display = "block";
  }
  else {
    allClassesLink.style.display = "none";
  }
  //-->
</script>
</div>
<a name="skip-navbar_bottom">
<!--   -->
</a></div>
<!-- ======== END OF BOTTOM NAVBAR ======= -->
<p class="legalCopy"><small>
          <script src='../../../../../prettify.js' type='text/javascript'></script>
          <script type='text/javascript'>
            (function(){
              var oldonload = window.onload;
              if (typeof oldonload != 'function') {
                window.onload = prettyPrint;
              } else {
                window.onload = function() {
                  oldonload();
                  prettyPrint();
                }
              }
            })();
          </script>
        </small></p>
</body>
</html>
